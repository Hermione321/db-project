@app.route("/", methods=["GET", "POST"])
@login_required
def index():
    product = None

    # Prüfen, welches Formular gesendet wurde
    form_type = request.form.get("form_type")

    if form_type == "barcode":
        barcode = request.form.get("barcode")
        category_name = BARCODES.get(barcode)
        if category_name:
            product = {
                "name": category_name,
                "materials": CATEGORIES.get(category_name, [])
            }
        else:
            product = {
                "name": "Unbekanntes Produkt",
                "materials": []
            }

    elif form_type == "todo":
        content = request.form.get("contents")
        due = request.form.get("due_at")
        if content and due:  # kleine Sicherheitsprüfung
            db_write(
                "INSERT INTO todos (user_id, content, due) VALUES (%s, %s, %s)",
                (current_user.id, content, due)
            )
        return redirect(url_for("index"))

    # Wenn kein Formular gesendet wurde oder GET-Request
    todos = db_read(
        "SELECT id, content, due FROM todos WHERE user_id=%s ORDER BY due",
        (current_user.id,)
    )

    return render_template("main_page.html", todos=todos, product=product)
