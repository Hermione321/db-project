{% extends "base.html" %}

{% block content %}
<div class="page-main">

  <h1>‚ôªÔ∏è TrashUp ‚Äì Abfall-App</h1>


  <!-- BARCODE -->
  <div class="card-soft">
    <h2>Produkt scannen</h2>

    <form method="POST">
      <input type="hidden" name="form_type" value="barcode">
      <input type="text" name="barcode" placeholder="Barcode eingeben" required>
      <button type="submit">Suchen</button>
    </form>

    {% if product %}
      <h3>{{ product.name }}</h3>

      {% if product.materials %}
        <ul>
          {% for material in product.materials %}
            {% if material.present %}
              <li class="material {{ material.name | lower }}">
                {{ material.name }} ‚úÖ
              </li>
            {% else %}
              <li class="material unknown">
                {{ material.name }} ‚ùå
              </li>
            {% endif %}
          {% endfor %}
        </ul>

        {% if alternative %}
          <p>
            üå± Umweltfreundlichere Alternative:
            <strong>{{ alternative[0] }}</strong>
            (Materialanzahl: {{ alternative[1] }})
          </p>
        {% else %}
          <p>‚úÖ Dieses Produkt ist bereits sehr umweltfreundlich.</p>
        {% endif %}
      {% else %}
        <p>Keine Materialinfos verf√ºgbar.</p>
      {% endif %}
    {% endif %}
  </div>

  <!-- LINKS -->
  <div class="card-soft">
    <h2>Kategorien ansehen</h2>
    <a class="link-button" href="{{ url_for('categories_page') }}">Zu den Kategorien</a>
  </div>

  <div class="card-soft">
    <h2>Deine Pluspunkte ansehen</h2>
    <a class="link-button" href="{{ url_for('points_page') }}">Zu den Pluspunkten</a>
  </div>

  <!-- KARTE -->
  <div class="card-soft">
    <h2>üó∫Ô∏è Entsorgungsstellen in deiner N√§he</h2>
    <button type="button" onclick="loadRecycling()">Standort verwenden</button>
    <div id="map" style="height: 400px; margin-top: 15px; border-radius: 12px;"></div>
  </div>
  

  <!-- ENTSORGUNGSSTELLEN LISTE -->
<div class="card-soft">
  <h2>‚ôªÔ∏è Entsorgungsstellen (Liste)</h2>

  {% if entsorgungsstellen %}
    <ul class="recycling-list">
      {% for stelle in entsorgungsstellen %}
        <li class="recycling-item">
          <strong>{{ stelle.name }}</strong><br>
          üìç {{ stelle.adresse }}<br>
          üè∑Ô∏è {{ stelle.typ }}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Keine Entsorgungsstellen verf√ºgbar.</p>
  {% endif %}
</div>

  <script>
    function loadRecycling() {
      if (!navigator.geolocation) {
        alert("Standort wird nicht unterst√ºtzt");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        const map = L.map("map").setView([lat, lon], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap"
        }).addTo(map);

        L.marker([lat, lon]).addTo(map).bindPopup("üìç Dein Standort").openPopup();

        try {
          const response = await fetch(`/entsorgung?lat=${lat}&lon=${lon}`);
          const data = await response.json();
          const elements = data.elements || [];

          elements.forEach(e => {
            const elLat = e.lat || (e.center && e.center.lat);
            const elLon = e.lon || (e.center && e.center.lon);
            if (elLat && elLon) {
              L.marker([elLat, elLon]).addTo(map).bindPopup("‚ôªÔ∏è Entsorgungsstelle");
            }
          });
        } catch (err) {
          console.log("Karte: Fehler", err);
        }
      });
    }
  </script>

</div>
{% endblock %}

# -------------------------
# Pluspunkte logic
# -------------------------

POINTS_PER_WASTE = {
    "pet": 2,
    "glas": 3,
    "aluminium": 2,
    "papier": 1,
}

def get_user_points(user_id):
    row = db_read(
        "SELECT COALESCE(pluspoints, 0) FROM users WHERE id = ?",
        (user_id,),
        one=True
    )
    return row[0] if row else 0

def add_user_points(user_id, amount):
    db_write(
        "UPDATE users SET pluspoints = COALESCE(pluspoints, 0) + ? WHERE id = ?",
        (amount, user_id)
    )


# -------------------------
# MAIN PAGE (GET + POST)
# -------------------------

@app.route("/", methods=["GET", "POST"])
def main_page():
    user_id = session["user_id"]
    message = None

    if request.method == "POST":
        waste = request.form.get("waste")

        if waste in POINTS_PER_WASTE:
            amount = POINTS_PER_WASTE[waste]
            add_user_points(user_id, amount)
            message = f"+{amount} Punkte gutgeschrieben üéâ"

    points = get_user_points(user_id)

    return render_template(
        "main.html",
        points=points,
        message=message
    )
